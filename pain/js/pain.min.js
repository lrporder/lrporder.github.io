function throwError(message,log){var t=document.getElementById("loadError");t.innerHTML+=message+"<br>";t.style.display="block";if(log)console.log(log)}function hideError(){$("#loadError").empty().hide()}function toggleDisplay(target){var t=document.getElementById(target);t.style.display=t.style.display=="block"?"none":"block"}function makeFile(content){var xmlFile=null;var data=new Blob([content],{type:"text/xml"});if(xmlFile!==null){window.URL.revokeObjectURL(xmlFile)}xmlFile=window.URL.createObjectURL(data);return xmlFile}function changeFileTag(xml,tag,oldValue,newValue){var oldString="<"+tag+">"+oldValue+"</"+tag+">";var newString="<"+tag+">"+newValue+"</"+tag+">";var regex=new RegExp(oldString,"g");var newXML=xml.replace(regex,newString);return newXML}function getTimeStamp(){var t=new Date,Y=t.getFullYear(),M=(t.getMonth()+1<10?"0":"")+(t.getMonth()+1),D=(t.getDate()<10?"0":"")+t.getDate(),hh=(t.getHours()<10?"0":"")+t.getHours(),mm=(t.getMinutes()<10?"0":"")+t.getMinutes(),ss=(t.getSeconds()<10?"0":"")+t.getSeconds(),newTimeStamp=Y+M+D+hh+mm+ss;return newTimeStamp}function changeFile(f){var newReqdColltnDt=$("#newReqdColltnDt").val();var newXML=changeFileTag(f,"ReqdColltnDt",ReqdColltnDt,newReqdColltnDt);var regexTS=new RegExp(oldTimeStamp,"g");var newTimeStamp=getTimeStamp();var newXML=newXML.replace(regexTS,newTimeStamp);newFiles.push(newXML)}function validateXml(f,c,nr){fileName=f.name.replace(/^.*?([^\\\/]*)$/,"$1");fileNameProper=fileName.replace(/\.[^\/.]+$/,"");var regexFN=new RegExp(fileNameProper,"g");fileNameExt=fileName.replace(regexFN,"");fileNames.push(fileName);newFileNames.push(fileName);try{if(fileNameExt!=".P"&&fileNameExt.toUpperCase()!=".XML")throw" heeft onjuiste bestandsextensie.";var xmlStart=c.substring(0,5);if(xmlStart!="<?xml")throw" is geen XML-bestand.";var cXml=$.parseXML(c);var xmlns=$(cXml).find("Document").attr("xmlns");if(xmlns!="urn:iso:std:iso:20022:tech:xsd:pain.008.001.02")throw" is geen PAIN-bestand.";var MsgId=$(c).find("MsgId").text();if(MsgId=="")throw" is corrupt (MsgId leeg)";oldTimeStamp=MsgId.split("-")[2];if(oldTimeStamp.length!==14)throw" komt niet uit LRP (geen timestamp in MsgId)";var EndToEndId=$(c).find("EndToEndId").first().text();fileAlreadyModified=EndToEndId.length==16?false:true}catch(e){var error="Fout: "+fileName+e;throwError(error,error);fileStats.push(error);oldFiles.push("ERROR occurred with "+fileName);newFiles.push("ERROR occurred with "+fileName);return false}fileStats.push("&#10004;");oldFiles.push(c);return true}function filePreview(n,filename){var spanTagIn='<span class="xmlLine">',spanTagOut="</span>",spanTagInDiff='<span class="xmlLine xmlLineDiff">';var oldFileTmp=oldFiles[n].replace(/>/g,"&gt").replace(/</g,"&lt").replace(/&gt&lt/g,"&gtQ@Q&lt");var newFileTmp=newFiles[n].replace(/>/g,"&gt").replace(/</g,"&lt").replace(/&gt&lt/g,"&gtQ@Q&lt");var oldFileParts=oldFileTmp.split(/Q@Q|\r\n|\r|\n/);var newFileParts=newFileTmp.split(/Q@Q|\r\n|\r|\n/);var oldFilePretty=[],newFilePretty=[];var indent=["&nbsp;","&nbsp;"];for(i in oldFileParts){if(oldFileParts[i]===newFileParts[i]){oldFilePretty.push(spanTagIn+oldFileParts[i]+spanTagOut);newFilePretty.push(spanTagIn+newFileParts[i]+spanTagOut)}else{oldFilePretty.push(spanTagInDiff+oldFileParts[i]+spanTagOut);newFilePretty.push(spanTagInDiff+newFileParts[i]+spanTagOut)}}$("#xmlContent").html(oldFilePretty.join(""));$("#xmlNewContent").html(newFilePretty.join(""));$("#previewContainer").show();var newPreviewTitle="Preview "+filename;$("#previewTitle").text(newPreviewTitle)}function showDetails(f,xml,nr){var NbOfTxs="",CtrlSum="",ReqdColltnDt="";if(fileStats[nr]=="&#10004;"){var fileStatus=fileStats[nr];var fileStatusClass="fileOK";var ReqdColltnDt=$(xml).find("ReqdColltnDt").first().text();var NbOfTxs=$(xml).find("NbOfTxs").first().text();var CtrlSum="â‚¬ "+$(xml).find("CtrlSum").first().text();var newReqdColltnDt=$("#newReqdColltnDt").val();var newXML=changeFileTag(xml,"ReqdColltnDt",ReqdColltnDt,newReqdColltnDt);newFileNames.push(fileName);if($("#aangeboden").is(":checked")){var fileNameProper=fileNames[nr].replace(/\.[^\/.]+$/,"");var regexFN=new RegExp(fileNameProper,"g");var fileNameExt=fileName.replace(regexFN,"");var fileNameParts=fileNameProper.split("_");if(fileNameParts.length==5){fnLastPart=parseInt(fileNameParts[4]);fnIndex=isNaN(fnLastPart)?fileNameParts[4]+"_1":fnLastPart+1;fileNameParts[4]=fnIndex}else{fileNameParts.push("1")}newFileNames[nr]=fileNameParts.join("_")+fileNameExt;$(newXML).find("EndToEndId").each(function(){id=$(this).text();if(id.length==16){newid=id+"0"}else{var idArr=id.split("");idArr[id.length-1]=parseInt(idArr.pop())+1;newid=idArr.join("")}regexID=new RegExp(id);newXML=newXML.replace(id,newid)})}var regexTS=new RegExp(oldTimeStamp,"g");var newTimeStamp=getTimeStamp();var newXML=newXML.replace(regexTS,newTimeStamp);newFiles.push(newXML);var filePreviewString='<a class="button" onclick="filePreview(\''+nr+"', '"+fileName+"')\">Preview</a>";var fileDownloadString='<a class="button" href="'+makeFile(newFiles[nr])+'" download="'+newFileNames[nr]+'">Download</a>'}else{var fileStatus="&#10008;";var fileStatusClass="fileNotOK";var filePreviewString="";var fileDownloadString="";newFiles.push(xml);newFileNames.push(fileName)}var rowContent='<tr class="rowFileDetails">';rowContent+="<td>"+(nr+1)+"</td>";rowContent+="<td>"+f.name+"</td>";rowContent+="<td>"+NbOfTxs+"</td>";rowContent+="<td>"+CtrlSum+"</td>";rowContent+="<td>"+ReqdColltnDt+"</td>";rowContent+='<td class="'+fileStatusClass+'" title="'+fileStats[nr]+'">'+fileStatus+"</td>";rowContent+="<td>"+filePreviewString+"&nbsp;"+fileDownloadString+"</td>";rowContent+="</tr>";$("#tableDetails").append(rowContent).show()}function downloadZipFile(){var zip=new JSZip;$.each(newFiles,function(i,newFile){if(fileStats[i]=="&#10004;"){zip.file(newFileNames[i],newFile)}});zip.generateAsync({type:"blob"}).then(function(blob){saveAs(blob,"Bestanden.zip")})}$(document).ready(function(){$.datepicker.setDefaults({showOn:"focus",dateFormat:"yy-mm-dd",beforeShowDay:$.datepicker.noWeekends,altField:"#humanReadableDate",altFormat:"DD, d MM yy",autoSize:true,changeMonth:true,changeYear:true,dayNamesMin:["Z","M","D","W","D","V","Z"],defaultDate:+2,minDate:+2,monthNames:["Januari","Februari","Maart","April","Mei","Juni","Juli","Augustus","September","Oktober","November","December"],nextText:"volgende",prevText:"vorige",showOtherMonths:true,selectOtherMonths:true});$("#newReqdColltnDt").datepicker();$("#xmlContent").on("scroll",function(){$("#xmlNewContent").scrollTop($("#xmlContent").scrollTop())});$("#file").on("click",function(evt){if($("#newReqdColltnDt").val()==""){throwError("Vul gewenste incassodatum in s.v.p.");evt.preventDefault()}});$("#file").on("change",function(evt){if($("#newReqdColltnDt").val()==""){throwError("Vul gewenste incassodatum in s.v.p.");$(this).val("");return false}$(".rowFileDetails").remove();$("#previewContainer").hide();var files=evt.target.files;hideError();fileStats=[];oldFiles=[];newFiles=[];fileNames=[];newFileNames=[];if(files){$("#newReqdColltnDt,#aangeboden").prop("disabled",true);$.each(files,function(i,file){var reader=new FileReader;reader.onload=function(loadedFile){return function(e){var xml=e.target.result;validateXml(loadedFile,xml,i);showDetails(loadedFile,xml,i)}}(file);reader.readAsText(file,"UTF-8")})}else{console.log("Failed to load file(s)")}})});
